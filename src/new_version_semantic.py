import requests
from concurrent.futures import ThreadPoolExecutor, as_completed
from gensim.models import KeyedVectors
import gensim.downloader as api
import sys
import time
import csv

def load_wordlist(file_path):
    with open(file_path, 'r') as file:
        return file.read().splitlines()

def check_url(base_url, path):
    url = f"{base_url}/{path}"
    try:
        response = requests.get(url, timeout=5)
        if response.status_code == 200:
            return url, True
    except requests.RequestException as e:
        print(f"Request Exception for {url}: {e}")
    return url, False

def semantic_sort(wordlist, base_path, model):
    base_word = base_path.split('/')[-1]
    if base_word in model.key_to_index:
        sorted_wordlist = sorted(wordlist, key=lambda x: model.similarity(base_word, x) if x in model.key_to_index else -1, reverse=True)
        return sorted_wordlist
    return wordlist

def write_to_csv(file_name, path, hit_rate, time_taken):
    with open(file_name, mode='a', newline='') as file:
        csv_writer = csv.writer(file)
        csv_writer.writerow([path, hit_rate, time_taken])

def recursive_directory_buster(base_url, current_path, wordlist_file, model, max_threads=10, found_paths=None, total_requests=0, successful_hits=0, start_time=time.time()):
    if found_paths is None:
        found_paths = []

    full_url = f"{base_url}/{current_path}".rstrip('/')
    wordlist = load_wordlist(wordlist_file)
    sorted_wordlist = semantic_sort(wordlist, current_path, model)

    with ThreadPoolExecutor(max_workers=max_threads) as executor:
        future_to_path = {executor.submit(check_url, full_url, path): path for path in sorted_wordlist}
        for future in as_completed(future_to_path):
            url, success = future.result()
            total_requests += 1
            if success:
                successful_hits += 1
                current_hit_rate = (successful_hits / total_requests) * 100
                current_time_taken = time.time() - start_time
                full_path = f"{current_path}/{future_to_path[future]}".rstrip('/')
                found_paths.append(full_path)
                write_to_csv('results_semantic.csv', full_path, current_hit_rate, current_time_taken)
                recursive_directory_buster(base_url, full_path, wordlist_file, model, max_threads, found_paths, total_requests, successful_hits, start_time)

    return found_paths, total_requests, successful_hits

if __name__ == "__main__":
    base_url = 'https://as.com'
    wordlist_file = 'docs/dirbusterListSmallTest.txt'
    model = api.load("word2vec-google-news-300")

    start_time = time.time()
    found_paths, total_requests, successful_hits = recursive_directory_buster(base_url, '', wordlist_file, model)
    end_time = time.time()

    print(f"\nTotal Hit Rate: {successful_hits/total_requests * 100:.2f}%")
    print(f"Total Time Taken: {end_time - start_time:.2f} seconds")

# C:\Users\bp4922\PycharmProjects\pythonProject\venv\Scripts\python.exe C:\Users\bp4922\PycharmProjects\pythonProject\src\new_version.py
# Hit Rate after finding /homepage: 0.78%
# Top 5 words after semantic sort for: homepage ['homepage', 'web', 'site', 'www', 'online']
# Hit Rate after finding /baloncesto: 1.27%
# Hit Rate after finding /baloncesto/nba: 0.94%
# Top 5 words after semantic sort for: nba ['nba', 'i', 'linux', 'futbol', 'english']
# Hit Rate after finding /futbol: 1.82%
# Top 5 words after semantic sort for: futbol ['futbol', 'nba', 'sports', 'english', 'resultados']
# Hit Rate after finding /resultados: 2.40%
# Top 5 words after semantic sort for: resultados ['resultados', 'de', 'dir', 'i', 'fr']
# Hit Rate after finding /resultados/futbol: 2.67%
# Top 5 words after semantic sort for: futbol ['futbol', 'nba', 'sports', 'english', 'resultados']
# Hit Rate after finding /resultados/baloncesto: 1.80%
# Hit Rate after finding /resultados/baloncesto/nba: 1.40%
# Top 5 words after semantic sort for: nba ['nba', 'i', 'linux', 'futbol', 'english']
# Hit Rate after finding /resultados/baloncesto/nba/0: 1.40%
# Top 5 words after semantic sort for: 0 ['0', '6', '7', '8', '9']
# Request Exception for https://as.com//resultados/baloncesto/nba/other: HTTPSConnectionPool(host='resultados.as.com', port=443): Read timed out. (read timeout=5)
# Request Exception for https://as.com//resultados/baloncesto/nba/0/hardware: HTTPSConnectionPool(host='as.com', port=443): Read timed out. (read timeout=5)
#
# Successfully found directories:
# - /homepage
# - /baloncesto
# - /baloncesto/nba
# - /futbol
# - /resultados
# - /resultados/futbol
# - /resultados/baloncesto
# - /resultados/baloncesto/nba
# - /resultados/baloncesto/nba/0
#
# Hit Rate: 2.40%
# Time Taken: 90.28 seconds
#
# Process finished with exit code 0

